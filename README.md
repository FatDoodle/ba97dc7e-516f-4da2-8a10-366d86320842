# ba97dc7e-516f-4da2-8a10-366d86320842
电商业务场景2
来源于https://www.yuque.com/docs/share/ba97dc7e-516f-4da2-8a10-366d86320842的
场景分析
1:假设是秒杀场景
2:秒杀产品有限
3:一个用户只能秒杀一个商品
4:下单成功就算秒杀成功,后续还有订单支付环节
5:订单未支付超时取消后商品返还库存
6:1000tps/s

设计
1:客户端控制流量,用户提交秒杀请求后不允许重复提交
2:避免恶意请求绕开客户端,网关要做一层校验,利用nginx+lua+redis结构,以用户token+商品id为key,打回重复请求,注意存活时间要短
3:redis提前存放商品id和商品数量,利用incr扣减库存,因为是原子命令,不用担心并发问题,再通过返回值判断后续流程,如果incr返回值小于0,说明超卖,否则正常流程.注意redis不要使用主从
4:走到这一步说明没有超卖,可以选择插入数据库或者往mq发送消息
5:打到mysql的流量1000tps/s,mysql应付会有些勉强,做好压测,不行就分片/mq.
6:订单超时可以使用redis过期监听机制,也可以使用mq的过期队列/死信队列来做.
7:订单超时,查看数据库订单状态,如果已支付不做处理,如果未支付,redis增加库存
8:nginx和redis都是10w级qps,单台足以应对需求.可用性另外再说
